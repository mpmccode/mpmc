#!/bin/sh

if [ $# != 6 ]
then
	echo "usage: $0 <hostname> <compiler> <serial | parallel> <CUDA: yes|no> <QM Rotation: yes|no> <Coupled-Dipole VDW: yes|no>"
	echo "     hostnames: llnl lincoln bigben circe galactic dirac lonestar ranger spin time generic"
	echo "     compilers: gcc pgi icc"
	exit 1
fi


HOSTNAME=$1
COMPILER=$2
MODE=$3
CUDA=$4
QM_ROTATION=$5
VDW=$6

NVCC="nvcc"

case "$HOSTNAME" in
	"llnl")
		case "$COMPILER" in
			"gcc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -DACML_NOUNDERSCORE"
				EXTRA_LIBS="-rpath /opt/pgi-7.2.5/libso -L/usr/local/tools/acml-pgi/lib -lpgc -lacml -lacml_mv -lpgftnrtl -lrt -lm"
			;;
			"icc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
			;;
		esac
	;;
	"lincoln")
		case "$COMPILER" in
			"gcc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -DACML_NOUNDERSCORE"
				EXTRA_LIBS="-lpgc -lpgftnrtl -lrt -lm"
			;;
			"icc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
			;;
		esac
	;;
	"bigben")
		case "$COMPILER" in
			"gcc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"pgi")
				CC="cc"
				CFLAGS="-O3 -fastsse -Mnontemporal -Mprefetch=distance:8,nta"
			;;
			"icc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
			;;
		esac
	;;
	"circe")
		case "$COMPILER" in
			"gcc")

				CC="gcc"
				CFLAGS="-O3 -std=c99"
				EXTRA_LIBS="-L./lib/ -lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lrt -lm"
				ln -s /usr/lib64/liblapack.so.3 ./lib/liblapack.a
				ln -s /usr/lib64/libg2c.so.0 ./lib/libg2c.a
				ln -s /usr/lib64/libblas.so.3 ./lib/libblas.a
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -Mipa=fast,inline,libinline,safe"
				EXTRA_LIBS="-L./lib/ -lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lm"
				ln -s /usr/lib64/liblapack.so.3 ./lib/liblapack.a
				ln -s /usr/lib64/libg2c.so.0 ./lib/libg2c.a
				ln -s /usr/lib64/libblas.so.3 ./lib/libblas.a
			;;
			"icc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	"dirac")
		case "$COMPILER" in
			"gcc")
				CC="gcc"
				CFLAGS="-O3 -std=c99"
				EXTRA_LIBS="-L/usr/local/pgi/linux86-64/7.0-6/libso/ -lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lrt -lm"
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -Mipa=fast,inline,libinline"
				EXTRA_LIBS="-L/usr/local/pgi/linux86-64/7.0-6/libso/ -lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lrt -lm"
			;;
			"icc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	"time")
		case "$COMPILER" in
			"gcc")
				CC="gcc"
				CFLAGS="-O3"
				EXTRA_LIBS="-lm"
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -Mipa=fast,inline,libinline"
				EXTRA_LIBS="-L/usr/local/pgi/linux86-64/7.0-6/libso/ -lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lrt -lm"
			;;
			"icc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	"galactic")
		case "$COMPILER" in
			"gcc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"pgi")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"icc")
				CC="icc"
				CFLAGS="-O3 -prefetch -mp -axP -ip -unroll"
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	"lonestar")
		case "$COMPILER" in
			"gcc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"pgi")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"icc")
				CC="icc"
				CFLAGS="-O3 -prefetch -mp -ip -unroll"
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	"ranger")
		case "$COMPILER" in
			"gcc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -tp barcelona-64"
				EXTRA_LIBS="-lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lm"
			;;
			"icc")
				echo "error: compiler $COMPILER not supported for hostname $HOSTNAME"
				exit 1
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	"spin")
		case "$COMPILER" in
			"gcc")
				CC="gcc"
				CFLAGS="-g0 -O3"
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-g0 -O3 -fastsse -Mipa=fast,inline,libinline"
			;;
			"icc")
				CC="icc"
				CFLAGS="-O3 -prefetch -mp -axN -ip -unroll"
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	"generic")
		case "$COMPILER" in
			"gcc")
				CC="gcc"
				CFLAGS="-O3"
				EXTRA_LIBS="-lm"
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3"
				EXTRA_LIBS="-lm"
			;;
			"icc")
				CC="icc"
				CFLAGS="-O3"
				EXTRA_LIBS="-lm"
			;;
			*)
				echo "error: unknown compiler $COMPILER"
				exit 1
		esac
	;;
	*)
		echo "error: unknown hostname $HOSTNAME"
		exit 1
	;;
esac

case "$MODE" in
	"serial")
		DEFINES="$DEFINES"
	;;
	"parallel")
		DEFINES="$DEFINES -DMPI"
		# handle special cases for parallelization
		case "$HOSTNAME" in
			"bigben")
				CC="cc"
			;;
			"dirac")
				EXTRA_INCLUDES="$EXTRA_INCLUDES -I/usr/include/openmpi/1.2.3-gcc"
				EXTRA_LIBS="$EXTRA_LIBS -L/usr/lib64/openmpi/1.2.3-gcc -lmpi -lm"
			;;
			"time")
				EXTRA_INCLUDES="-I/usr/include/openmpi/1.2.3-gcc"
				EXTRA_LIBS="-L/usr/lib64/openmpi/1.2.3-gcc -lmpi -lm"
			;;
			"spin")
				EXTRA_INCLUDES="-I/usr/include/openmpi"
				EXTRA_LIBS="-L/usr/lib64/openmpi -lmpi -lm"
			;;
			*)
				CC="mpicc"
			;;
		esac
	;;
	*)
		echo "error: unknown mode, must be serial or parallel"
		exit 1
	;;
esac

if [ $QM_ROTATION = "yes" ]
then
	DEFINES="$DEFINES -DQM_ROTATION"
fi

if [ $VDW = "yes" ]; then
	DEFINES="$DEFINES -DVDW"
	EXTRA_LIBS="$EXTRA_LIBS -llapack"
fi

if [ $CUDA = "yes" ]
then

	if [ $HOSTNAME = "circe" ]
	then
		DEFINES="$DEFINES -DCUDA"
		EXTRA_INCLUDES="$EXTRA_INCLUDES -I/opt/apps/cuda/3.0/include"
		EXTRA_LIBS="$EXTRA_LIBS -L/opt/apps/cuda/3.0/lib64 -lcudart"
	elif [ $HOSTNAME == "llnl" ]
	then
		DEFINES="$DEFINES -DCUDA"
		EXTRA_INCLUDES="$EXTRA_INCLUDES -I/opt/cudatoolkit-3.0/include"
		EXTRA_LIBS="$EXTRA_LIBS -L/opt/cudatoolkit-3.0/lib64 -lcudart"
	elif [ $HOSTNAME == "lincoln" ]
	then
		DEFINES="$DEFINES -DCUDA"
		EXTRA_INCLUDES="$EXTRA_INCLUDES -I/usr/local/cuda-3.0/include"
		EXTRA_LIBS="$EXTRA_LIBS -L/usr/local/cuda-3.0/lib64 -lcudart"
	else
		DEFINES="$DEFINES -DCUDA"
		EXTRA_LIBS="$EXTRA_LIBS -lcudart"
	fi
fi

echo > Makefile
echo "#HOSTNAME=$HOSTNAME COMPILER=$COMPILER MODE=$MODE CUDA=$CUDA QM_ROTATION=$QM_ROTATION" >> Makefile
echo "CC=$CC" >> Makefile
if [ $CUDA = "yes" ]
then
	echo "NVCC=$NVCC" >> Makefile
fi
echo "CFLAGS=$CFLAGS" >> Makefile
echo "DEFINES=$DEFINES" >> Makefile
echo "EXTRA_DEFINES=$EXTRA_DEFINES" >> Makefile
echo "EXTRA_INCLUDES=$EXTRA_INCLUDES" >> Makefile
echo "EXTRA_LIBS=$EXTRA_LIBS" >> Makefile
echo "CUDA=$CUDA" >> Makefile
echo "QM_ROTATION=$QM_ROTATION" >> Makefile
echo >> Makefile

echo "include Makefile.common" >> Makefile
echo >> Makefile

