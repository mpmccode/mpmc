#!/bin/sh

if [ $# != 6 ]
then
	echo "usage: $0 <hostname> <compiler> <serial | parallel> <CUDA: yes|no> <QM Rotation: yes|no> <Coupled-Dipole VDW: yes|no>"
	echo "     hostnames: generic circe llnl spin time"
	echo "     compilers: gcc gdb pgi icc"
	exit 1
fi


HOSTNAME=$1
COMPILER=$2
MODE=$3
CUDA=$4
QM_ROTATION=$5
VDW=$6

NVCC="nvcc"


## Check for machine and compiler. Set CC/CFLAGS/LIBS.
case "$HOSTNAME" in
	"llnl")
		case "$COMPILER" in
			"gdb")
				CC="gcc"
				CFLAGS="-g "
				EXTRA_LIBS="-lm -rdynamic"
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -DACML_NOUNDERSCORE"
				EXTRA_LIBS="-rpath /opt/pgi-7.2.5/libso -L/usr/local/tools/acml-pgi/lib -lpgc -lacml -lacml_mv -lpgftnrtl -lrt -lm"
			;;
			*)
				echo "error: compiler $COMPILER not supported for machine $HOSTNAME"
				exit 1
			;;
		esac
	;;
	"circe") #USF research computing
		case "$COMPILER" in
			"gdb")
				CC="gcc"
				CFLAGS="-g -Wall -Wall "
				EXTRA_LIBS="-lm -rdynamic"
			;;
			"gcc")
				echo "WARNING: The Intel(R) compiler, icc, is preferred for production work on CIRCE."
				CC="gcc"
				CFLAGS="-O3 -Wall -Werror "
				EXTRA_LIBS="-lm"
			;;
			"icc")
				CC="icc"
				CFLAGS="-O3 -ip -unroll -Wall -Werror-all"
				EXTRA_LIBS=
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -Mipa=fast,inline,libinline,safe -I/apps/legacy/pgi/linux86-64/10.1/include/CC/ -I/apps/legacy/pgi/linux86-64/10.1/include/ -I/usr/lib/gcc/x86_64-redhat-linux/4.4.4/include/"
				EXTRA_LIBS="-L./lib/ -lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lm"
				ln -s /usr/lib64/liblapack.so.3 ./lib/liblapack.a
				ln -s /usr/lib64/libg2c.so.0 ./lib/libg2c.a
				ln -s /usr/lib64/libblas.so.3 ./lib/libblas.a
			;;
			*)
				echo "error: compiler $COMPILER not supported for machine $HOSTNAME"
				exit 1
		esac
	;;
	"time") #time usf
		case "$COMPILER" in
			"gdb")
				CC="gcc"
				CFLAGS="-g"
				EXTRA_LIBS="-lm -rdynamic"
			;;
			"gcc")
				CC="gcc"
				CFLAGS="-O3"
				EXTRA_LIBS="-lm"
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -Mipa=fast,inline,libinline"
				EXTRA_LIBS="-L/usr/local/pgi/linux86-64/7.0-6/libso/ -lacml -lacml_mv -lacml_mp -lpgmp -lpgftnrtl -lrt -lm"
			;;
			*)
				echo "error: compiler $COMPILER not supported for machine $HOSTNAME"
				exit 1
		esac
	;;
	"spin") #spin usf
		case "$COMPILER" in
			"gdb")
				CC="gcc"
				CFLAGS="-g"
				EXTRA_LIBS="-lm -rdynamic"
			;;
			"gcc")
				CC="gcc"
				CFLAGS="-g0 -O3"
				EXTRA_LIBS="-lm"
			;;
			*)
				echo "error: compiler $COMPILER not supported for machine $HOSTNAME"
				exit 1
		esac
	;;
	"generic")
		case "$COMPILER" in
			"gdb")
				CC="gcc"
				CFLAGS="-g"
				EXTRA_LIBS="-lm -rdynamic"
			;;
			"gcc")
				CC="gcc"
				CFLAGS="-g0 -O3"
				EXTRA_LIBS="-lm"
			;;
			"pgi")
				CC="pgcc"
				CFLAGS="-O3 -fastsse -Mipa=fast,inline,libinline"
				EXTRA_LIBS="-lm"
			;;
			"icc")
				CC="icc"
				CFLAGS="-O3 -prefetch -mp -axN -ip -unroll"
				EXTRA_LIBS="-lm"
			;;
			*)
				echo "error: compiler $COMPILER not supported for machine $HOSTNAME"
				exit 1
		esac
	;;
	*) ## no machine match
		echo "error: unknown machine $HOSTNAME"
		exit 1
	;;
esac

## Serial/Parallel compilation
case "$MODE" in
	"serial")
		DEFINES="$DEFINES"
	;;
	"parallel")
		DEFINES="$DEFINES -DMPI"
		# handle special cases for parallelization
		case "$HOSTNAME" in
			"time")
				EXTRA_INCLUDES="-I/usr/include/openmpi/1.2.3-gcc"
				EXTRA_LIBS="-L/usr/lib64/openmpi/1.2.3-gcc -lmpi -lm"
			;;
			"spin")
				EXTRA_INCLUDES="-I/usr/include/openmpi"
				EXTRA_LIBS="-L/usr/lib64/openmpi -lmpi -lm"
			;;
			*)
				CC="mpicc"
			;;
		esac
	;;
	*)
		echo "error: unknown mode, must be serial or parallel"
		exit 1
	;;
esac

if [ $QM_ROTATION = "yes" ]
then
	DEFINES="$DEFINES -DQM_ROTATION"
fi

if [ $VDW = "yes" ]; then
	DEFINES="$DEFINES -DVDW"
	EXTRA_LIBS="$EXTRA_LIBS -llapack"
fi

if [ $CUDA = "yes" ]; then

	if [ $HOSTNAME = "circe" ]; then
		DEFINES="$DEFINES -DCUDA"
		EXTRA_INCLUDES="$EXTRA_INCLUDES -I/apps/cuda/6.0/include"
		EXTRA_LIBS="$EXTRA_LIBS -L/apps/cuda/6.0/lib64 -lcudart"
	elif [ $HOSTNAME == "llnl" ]; then
		DEFINES="$DEFINES -DCUDA"
		EXTRA_INCLUDES="$EXTRA_INCLUDES -I/opt/cudatoolkit-3.0/include"
		EXTRA_LIBS="$EXTRA_LIBS -L/opt/cudatoolkit-3.0/lib64 -lcudart"
	else
		DEFINES="$DEFINES -DCUDA"
		EXTRA_LIBS="$EXTRA_LIBS -lcudart"
	fi
fi

## Set CUDA flag
if [ $CUDA = "yes" ]; then
	NVCC=$NVCC
else
	NVCC=
fi

## Libs for gcc need to be specified in a different position
if [ $COMPILER = "gcc" ] || [ $COMPILER = "gdb" ] ; then
	GCC_EXTRA_LIBS=$EXTRA_LIBS
	EXTRA_LIBS=
else
	GCC_EXTRA_LIBS=
	EXTRA_LIBS=$EXTRA_LIBS
fi

## Some Mersenne Twister optimizations. Compiles fine without.
if [ $COMPILER = "gcc" ]; then
	MTFLAGS="-finline-functions -fomit-frame-pointer -fno-strict-aliasing --param max-inline-insns-single=1800 -std=c99"
fi

cat > Makefile << EOF

#HOSTNAME=$HOSTNAME COMPILER=$COMPILER MODE=$MODE CUDA=$CUDA QM_ROTATION=$QM_ROTATION" 
CC=$CC
CFLAGS=$CFLAGS

DEFINES=$DEFINES
EXTRA_INCLUDES=$EXTRA_INCLUDES -I../mersenne
EXTRA_LIBS=$EXTRA_LIBS
GCC_EXTRA_LIBS=$GCC_EXTRA_LIBS
CUDA=$CUDA
QM_ROTATION=$QM_ROTATION

NVCC=$NVCC

include Makefile.common

EOF

